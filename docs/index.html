<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Global Entry Appointment</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex items-center justify-center px-4">
<div class="max-w-xl w-full bg-white p-8 rounded-xl shadow-md">
    <h1 class="text-3xl font-bold text-center text-blue-600 mb-6">Global Entry Appointment</h1>

    <form id="alert-form" class="space-y-5">
        <div>
            <label for="location" class="block font-semibold mb-1">Enrollment Center</label>
            <select id="location" required class="w-full p-2 border border-gray-300 rounded">
                <option value="">Loading locations...</option>
            </select>
        </div>

        <div>
            <label for="topic" class="block font-semibold mb-1">Ntfy Topic</label>
            <input type="text" id="topic" placeholder="e.g. my-topic-123" required
                   class="w-full p-2 border border-gray-300 rounded" />
        </div>

        <div>
            <span class="block font-semibold mb-1">Action</span>
            <div class="flex gap-6">
                <label class="inline-flex items-center">
                    <input type="radio" id="subscribe" name="action" value="subscribe" checked class="mr-2">
                    Subscribe
                </label>
                <label class="inline-flex items-center">
                    <input type="radio" id="unsubscribe" name="action" value="unsubscribe" class="mr-2">
                    Unsubscribe
                </label>
            </div>
        </div>

        <button type="submit"
                class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">
            Submit
        </button>

        <p id="status" class="text-center font-semibold mt-2 text-sm"></p>
    </form>

    <div class="mt-8 p-4 border border-gray-300 rounded-lg bg-gray-50">
        <h2 class="text-lg font-semibold mb-2">ðŸ“± How to Get Push Notifications</h2>
        <p class="mb-2">
            This app uses <a href="https://ntfy.sh" target="_blank" class="text-blue-600 underline">ntfy.sh</a> for push notifications.
            To receive alerts:
        </p>
        <ul class="list-disc list-inside mb-2">
            <li><a href="https://apps.apple.com/us/app/ntfy/id1625396347" target="_blank" class="text-blue-600 underline">Download ntfy for iOS</a></li>
            <li><a href="https://play.google.com/store/apps/details?id=io.heckel.ntfy" target="_blank" class="text-blue-600 underline">Download ntfy for Android</a></li>
        </ul>
        <p class="mb-2">
            After installing, open the app and create a topic name (e.g. <code>my-global-entry-alerts</code>).
            Enter that topic above to subscribe for appointment alerts.
        </p>
        <p>
            You can test your topic at:
            <a href="https://ntfy.sh/my-global-entry-alerts" target="_blank" class="text-blue-600 underline">
                https://ntfy.sh/my-global-entry-alerts
            </a>
        </p>
    </div>
</div>

<script>
    async function fetchLocations() {
        try {
            const res = await fetch("https://ttp.cbp.dhs.gov/schedulerapi/locations/?temporary=false&inviteOnly=false&operational=true&serviceName=Global%20Entry");
            const locations = await res.json();

            locations.sort((a, b) => a.name.localeCompare(b.name));

            const select = document.getElementById("location");
            select.innerHTML = '<option value="">-- Select a location --</option>';

            locations.forEach(loc => {
                const labelParts = [
                    loc.name,
                    loc.addressAdditional || loc.address,
                    `${loc.city} ${loc.state} ${loc.postalCode}`
                ];
                const text = labelParts.filter(Boolean).join(" â€“ ");
                const option = new Option(text, loc.id);
                select.add(option);
            });
        } catch {
            document.getElementById("location").innerHTML = '<option>Error loading locations</option>';
        }
    }

    document.getElementById("alert-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const location = document.getElementById("location").value;
        const topic = document.getElementById("topic").value.trim();
        const action = document.querySelector('input[name="action"]:checked').value;

        if (!location || !topic) {
            document.getElementById("status").textContent = "Please fill out all fields.";
            return;
        }

        const payload = { action, location, ntfyTopic: topic };
        const endpoint = "https://52vuz4sy6kozejx3ams5kagm7u0htxal.lambda-url.us-east-1.on.aws/subscriptions";

        try {
            const res = await fetch(endpoint, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            });

            const text = await res.text();
            document.getElementById("status").textContent = text || "Request successful!";
        } catch {
            document.getElementById("status").textContent = "Error submitting request.";
        }
    });

    // Handle auto-check unsubscribe radio if query param is present
    window.addEventListener("DOMContentLoaded", () => {
        const params = new URLSearchParams(window.location.search);
        if (params.get("subscriptions") === "unsubscribe") {
            document.getElementById("unsubscribe").checked = true;
        }
    });

    fetchLocations();
</script>
</body>
</html>
